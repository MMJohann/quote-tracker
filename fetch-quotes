#!/usr/bin/python

from settings import getSettingsCacher
from instruments import *
from quotes import *
import datetime
from google.appengine.ext import db

print 'Content-Type: text/plain'
print ''

limit = 300

total = index = 0
while True:
    instrs = Instrument.all ().fetch (1000, index)
    if len (instrs) == 0:
        break
    index += len (instrs)

    for inst in instrs:
        source = sourceInstance (inst.source)
        start = inst.last_data
        if start == None:
            start = source.minDate ()
        start = start + datetime.timedelta (1)
        if start >= datetime.date.today ():
            continue
        count = 0
        results = source.fetchSimple (inst.symbol, start)

        for result in results:
            result.put ()
            if result.date > start:
                start = result.date
            count = count + 1
            total = total + 1
            if total >= limit:
                break

        if count == 0:
            print 'There is no new data for symbol %s' % inst.symbol
        else:
            inst.last_data = start
            inst.put ()
            print 'Symbol %(sym)s processed, %(count)d items added up to %(date)s' % {'sym' : inst.symbol, 'count' : count, 'date' : start.isoformat ()}
        if total >= limit:
            break

print 'OK'



def wipe ():
    q = db.GqlQuery ("select * from Quote")
    for quote in q:
        quote.delete ()
    print 'OK'
    exit ()
