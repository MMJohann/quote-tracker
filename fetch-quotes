#!/usr/bin/python

from settings import getSettingsCacher
from instruments import *
from quotes import *
import datetime

print 'Content-Type: text/plain'
print ''

index = 0
while True:
    instrs = Instrument.all ().fetch (1000, index)
    if len (instrs) == 0:
        break
    index += len (instrs)

    for inst in instrs:
        source = sourceInstance (inst.source)
        start = inst.last_data
        if start == None:
            start = datetime.date (1800, 1, 1)
        count = 0
        results = source.fetch (inst.symbol, start)
        
        for result in results:
            result.put ()
            if result.date > start:
                start = result.date
            count = count + 1

        inst.last_data = start
        inst.put ()
        print 'Symbol %(sym)s processed, %(count)d items added up to %(date)s' % {'sym' : inst.symbol, 'count' : count, 'date' : start.isoformat ()}

print 'OK'
